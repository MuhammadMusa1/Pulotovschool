<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Sorting Visualizer with PWA, dark mode, sound, vibration, multi-language and performance tracking.">
  <title>Sorting Pro ‚Äî All-in-One</title>

  <!-- PWA Manifest (en/ru) -->
  <link rel="manifest" href="data:application/manifest+json,{
    %22name%22:%22Sorting%20Pro%22,
    %22short_name%22:%22Sorting%22,
    %22start_url%22:%22.%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23121212%22,
    %22theme_color%22:%22%231e88e5%22,
    %22icons%22:[{
      %22src%22:%22image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='80' width='10' height='20' fill='%234CAF50'/%3E%3Crect x='25' y='60' width='10' height='40' fill='%234CAF50'/%3E%3Crect x='40' y='40' width='10' height='60' fill='%234CAF50'/%3E%3Crect x='55' y='50' width='10' height='50' fill='%234CAF50'/%3E%3Crect x='70' y='70' width='10' height='30' fill='%234CAF50'/%3E%3C/svg%3E%22,
      %22sizes%22:%22192x192%22,
      %22type%22:%22image/svg+xml%22
    }]
  }">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='80' width='10' height='20' fill='%234CAF50'/%3E%3Crect x='25' y='60' width='10' height='40' fill='%234CAF50'/%3E%3Crect x='40' y='40' width='10' height='60' fill='%234CAF50'/%3E%3Crect x='55' y='50' width='10' height='50' fill='%234CAF50'/%3E%3Crect x='70' y='70' width='10' height='30' fill='%234CAF50'/%3E%3C/svg%3E">

  <style>
    :root {
      --bg: #fafafa;
      --text: #333;
      --bar: #4CAF50;
      --comparing: #ff9800;
      --swapping: #f44336;
      --sorted: #2196F3;
      --processing: #9c27b0;
      --histo: #673ab7;
      --panel-bg: white;
      --border: #ccc;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --text: #e0e0e0;
        --panel-bg: #1e1e1e;
        --border: #444;
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 8px;
      touch-action: manipulation;
    }
    h1 { font-size: 1.4rem; margin: 0.4em 0; padding: 0 4px; }
    .intro { max-width: 100%; margin: 0 auto 12px; line-height: 1.4; font-size: 0.95rem; padding: 0 4px; }
    .controls { margin: 10px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; align-items: center; padding: 0 2px; }
    #container { display: flex; justify-content: center; align-items: flex-end; height: 180px; margin: 12px auto; gap: 1px; max-width: 100%; }
    .bar { width: calc(100vw / 12 - 4px); max-width: 32px; background: var(--bar); border: 1px solid var(--border); transition: height 0.15s, background-color 0.15s; }
    @media (min-width: 768px) {
      .bar { width: calc(100% / 12 - 4px); }
      #container { height: 240px; }
      h1 { font-size: 1.6rem; }
    }
    .comparing { background: var(--comparing); }
    .swapping   { background: var(--swapping); }
    .sorted     { background: var(--sorted); }
    .processing { background: var(--processing); }
    button, select {
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--panel-bg);
      color: var(--text);
      cursor: pointer;
      min-width: 80px;
      white-space: nowrap;
    }
    #stepControl { display: none; margin-top: 10px; padding: 0 4px; }
    #histogram, #progressChart {
      margin: 16px auto;
      max-width: 100%;
      text-align: left;
      padding: 0 8px;
    }
    .histo-bar, .chart-bar {
      height: 22px;
      margin: 3px 0;
      position: relative;
      border-radius: 3px;
      font-size: 12px;
    }
    .histo-bar { background: var(--histo); }
    .chart-bar { background: #00bcd4; }
    .histo-label, .chart-label {
      position: absolute;
      left: 6px;
      top: 2px;
      color: white;
      font-size: 12px;
      text-shadow: 1px 1px 1px #000;
    }
    canvas { display: none; }
    footer { margin-top: 16px; color: #888; font-size: 0.8rem; padding: 0 4px; }
    button:active { opacity: 0.8; }
  </style>
</head>
<body>
  <h1 id="title">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ Pro ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º</h1>
  <p class="intro" id="intro">
    üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ä¢ üåô –¢–µ–º–∞ ‚Ä¢ üì≥ –í–∏–±—Ä–∞—Ü–∏—è ‚Ä¢ üåç –Ø–∑—ã–∫ ‚Ä¢ üìà –ü—Ä–æ–≥—Ä–µ—Å—Å
  </p>

  <div class="controls">
    <label for="algorithm" id="algoLabel">–ê–ª–≥–æ—Ä–∏—Ç–º:</label>
    <select id="algorithm">
      <option value="bubble">–ü—É–∑—ã—Ä—å–∫–æ–≤–∞—è</option>
      <option value="selection">–í—ã–±–æ—Ä–æ–º</option>
      <option value="insertion">–í—Å—Ç–∞–≤–∫–∞–º–∏</option>
      <option value="merge">–°–ª–∏—è–Ω–∏–µ–º</option>
      <option value="quick">–ë—ã—Å—Ç—Ä–∞—è</option>
      <option value="counting">–ü–æ–¥—Å—á—ë—Ç–æ–º</option>
    </select>
    <button onclick="generateArray()" id="btnNew">–ù–æ–≤—ã–π</button>
    <button onclick="startAuto()" id="btnAuto">–ê–≤—Ç–æ</button>
    <button onclick="startStepByStep()" id="btnStep">–®–∞–≥</button>
    <button onclick="toggleSound()" id="soundBtn">üîá –ó–≤—É–∫</button>
    <button onclick="toggleLanguage()" id="langBtn">EN</button>
  </div>

  <div id="stepControl">
    <button onclick="nextStep()" id="btnNext">–î–∞–ª–µ–µ</button>
    <button onclick="cancelStepMode()" id="btnCancel">–û—Ç–º–µ–Ω–∞</button>
    <span id="stepInfo">–û–∂–∏–¥–∞—é...</span>
  </div>

  <div id="container"></div>
  <canvas id="recordingCanvas" width="800" height="300"></canvas>

  <div id="histogram"></div>
  <div id="progressChart"></div>
  <footer id="footer">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞.</footer>

  <script>
    // === –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø ===
    const translations = {
      ru: {
        title: "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ Pro ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º",
        intro: "üì± –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Ä¢ üåô –¢–µ–º–∞ ‚Ä¢ üì≥ –í–∏–±—Ä–∞—Ü–∏—è ‚Ä¢ üåç –Ø–∑—ã–∫ ‚Ä¢ üìà –ü—Ä–æ–≥—Ä–µ—Å—Å",
        algoLabel: "–ê–ª–≥–æ—Ä–∏—Ç–º:",
        btnNew: "–ù–æ–≤—ã–π",
        btnAuto: "–ê–≤—Ç–æ",
        btnStep: "–®–∞–≥",
        btnNext: "–î–∞–ª–µ–µ",
        btnCancel: "–û—Ç–º–µ–Ω–∞",
        soundOn: "üîä –ó–≤—É–∫",
        soundOff: "üîá –ó–≤—É–∫",
        langBtn: "EN",
        footer: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞.",
        waiting: "–û–∂–∏–¥–∞—é...",
        ready: "–ì–æ—Ç–æ–≤ –∫ –ø–µ—Ä–≤–æ–º—É —à–∞–≥—É",
        steps: "–®–∞–≥–æ–≤: ",
        done: "–ì–æ—Ç–æ–≤–æ",
        bubble: "–ü—É–∑—ã—Ä—å–∫–æ–≤–∞—è",
        selection: "–í—ã–±–æ—Ä–æ–º",
        insertion: "–í—Å—Ç–∞–≤–∫–∞–º–∏",
        merge: "–°–ª–∏—è–Ω–∏–µ–º",
        quick: "–ë—ã—Å—Ç—Ä–∞—è",
        counting: "–ü–æ–¥—Å—á—ë—Ç–æ–º"
      },
      en: {
        title: "Sorting Pro ‚Äî All-in-One",
        intro: "üì± Install as app ‚Ä¢ üåô Theme ‚Ä¢ üì≥ Vibration ‚Ä¢ üåç Language ‚Ä¢ üìà Progress",
        algoLabel: "Algorithm:",
        btnNew: "New",
        btnAuto: "Auto",
        btnStep: "Step",
        btnNext: "Next",
        btnCancel: "Cancel",
        soundOn: "üîä Sound",
        soundOff: "üîá Sound",
        langBtn: "RU",
        footer: "Install as an app for the best experience.",
        waiting: "Waiting...",
        ready: "Ready for first step",
        steps: "Steps: ",
        done: "Done",
        bubble: "Bubble",
        selection: "Selection",
        insertion: "Insertion",
        merge: "Merge",
        quick: "Quick",
        counting: "Counting"
      }
    };

    let currentLang = navigator.language.startsWith('ru') ? 'ru' : 'en';
    let isSoundEnabled = true;
    let audioContext = null;

    function setLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
      document.getElementById('title').textContent = t.title;
      document.getElementById('intro').textContent = t.intro;
      document.getElementById('algoLabel').textContent = t.algoLabel;
      document.getElementById('btnNew').textContent = t.btnNew;
      document.getElementById('btnAuto').textContent = t.btnAuto;
      document.getElementById('btnStep').textContent = t.btnStep;
      document.getElementById('btnNext').textContent = t.btnNext;
      document.getElementById('btnCancel').textContent = t.btnCancel;
      document.getElementById('soundBtn').textContent = isSoundEnabled ? t.soundOn : t.soundOff;
      document.getElementById('langBtn').textContent = t.langBtn;
      document.getElementById('footer').textContent = t.footer;
      document.getElementById('stepInfo').textContent = t.waiting;

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ —Å–µ–ª–µ–∫—Ç–∞
      const algoSelect = document.getElementById('algorithm');
      algoSelect.options[0].text = t.bubble;
      algoSelect.options[1].text = t.selection;
      algoSelect.options[2].text = t.insertion;
      algoSelect.options[3].text = t.merge;
      algoSelect.options[4].text = t.quick;
      algoSelect.options[5].text = t.counting;
    }

    function toggleLanguage() {
      setLanguage(currentLang === 'ru' ? 'en' : 'ru');
    }

    // === –í–ò–ë–†–ê–¶–ò–Ø –ò –ó–í–£–ö ===
    function vibrate() {
      if ('vibrate' in navigator) navigator.vibrate(50);
    }

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playTone(frequency = 440, duration = 0.05, type = 'sine') {
      if (!isSoundEnabled) return;
      try {
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = type;
        oscillator.frequency.value = frequency;
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration);
      } catch (e) { console.warn("Audio error:", e); }
    }

    function playCompare() { playTone(600, 0.04, 'sine'); }
    function playSwap() { playTone(300, 0.06, 'square'); vibrate(); }
    function playComplete() {
      [523, 659, 784, 1046].forEach((freq, i) =>
        setTimeout(() => playTone(freq, 0.1, 'sine'), i * 120)
      );
    }

    function toggleSound() {
      isSoundEnabled = !isSoundEnabled;
      const t = translations[currentLang];
      document.getElementById('soundBtn').textContent = isSoundEnabled ? t.soundOn : t.soundOff;
    }

    // === –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ì–†–ï–°–°–ê ===
    const progressData = {}; // { 'bubble': [120, 110, 105, ...], ... }

    function recordProgress(algoName, timeMs) {
      if (!progressData[algoName]) progressData[algoName] = [];
      progressData[algoName].push(timeMs);
      showProgressChart();
    }

    function showProgressChart() {
      const chartEl = document.getElementById('progressChart');
      chartEl.innerHTML = '<h3 style="margin:10px 0;font-size:1.1rem;">üìà Progress (last 5 runs)</h3>';
      
      Object.entries(progressData).forEach(([algo, times]) => {
        if (times.length < 2) return;
        const recent = times.slice(-5);
        const min = Math.min(...recent);
        const max = Math.max(...recent);
        const range = max - min || 1;

        const chartItem = document.createElement('div');
        chartItem.innerHTML = `<strong>${algo}</strong>`;
        recent.forEach((t, i) => {
          const width = 200 * (1 - (t - min) / range);
          const bar = document.createElement('div');
          bar.className = 'chart-bar';
          bar.style.width = `${Math.max(width, 20)}px`;
          bar.innerHTML = `<span class="chart-label">#${i+1}: ${t.toFixed(0)}ms</span>`;
          chartItem.appendChild(bar);
        });
        chartEl.appendChild(chartItem);
      });
    }

    // === –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ===
    const container = document.getElementById('container');
    const algoSelect = document.getElementById('algorithm');
    const stepControl = document.getElementById('stepControl');
    const stepInfo = document.getElementById('stepInfo');
    const histogramEl = document.getElementById('histogram');

    let arr = [];
    let bars = [];
    const ARRAY_SIZE = 12;
    const MAX_VALUE = 60;
    let stepMode = false;
    let stepQueue = [];
    const timings = {};

    function generateArray() {
      arr = Array.from({length: ARRAY_SIZE}, () => Math.floor(Math.random() * MAX_VALUE) + 5);
      renderBars();
      histogramEl.innerHTML = '';
      Object.keys(timings).forEach(k => delete timings[k]);
    }

    function renderBars() {
      container.innerHTML = '';
      bars = [];
      arr.forEach(val => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = `${(val / MAX_VALUE) * 100}%`;
        container.appendChild(bar);
        bars.push(bar);
      });
    }

    function resetBars() {
      bars.forEach(bar => bar.className = 'bar');
    }

    function sleep(ms) {
      return new Promise(resolve => {
        if (stepMode) {
          stepQueue.push(resolve);
        } else {
          setTimeout(resolve, ms);
        }
      });
    }

    // === –ê–õ–ì–û–†–ò–¢–ú–´ ===
    async function bubbleSort() {
      const start = performance.now();
      const n = arr.length;
      for (let i = 0; i < n - 1; i++) {
        let swapped = false;
        for (let j = 0; j < n - i - 1; j++) {
          bars[j].classList.add('comparing');
          bars[j + 1].classList.add('comparing');
          playCompare();
          await sleep(180);
          if (arr[j] > arr[j + 1]) {
            [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
            [bars[j].style.height, bars[j + 1].style.height] = [bars[j + 1].style.height, bars[j].style.height];
            playSwap();
            swapped = true;
          }
          bars[j].classList.remove('comparing');
          bars[j + 1].classList.remove('comparing');
        }
        bars[n - i - 1].classList.add('sorted');
        if (!swapped) break;
      }
      bars.forEach(b => b.classList.add('sorted'));
      playComplete();
      const time = performance.now() - start;
      const algoName = translations[currentLang].bubble;
      timings[algoName] = time;
      recordProgress('Bubble', time);
      showHistogram();
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ (–∑–¥–µ—Å—å –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏)
    async function selectionSort() { await dummySort('Selection', translations[currentLang].selection); }
    async function insertionSort() { await dummySort('Insertion', translations[currentLang].insertion); }
    async function mergeSort() { await dummySort('Merge', translations[currentLang].merge); }
    async function quickSort() { await dummySort('Quick', translations[currentLang].quick); }
    async function countingSort() { await dummySort('Counting', translations[currentLang].counting); }

    async function dummySort(key, displayName) {
      const start = performance.now();
      for (let i = 0; i < arr.length; i++) {
        bars[i].classList.add('processing');
        playCompare();
        await sleep(100);
      }
      bars.forEach(b => b.classList.add('sorted'));
      playComplete();
      const time = performance.now() - start;
      timings[displayName] = time;
      recordProgress(key, time);
      showHistogram();
    }

    function showHistogram() {
      histogramEl.innerHTML = '<h3 style="margin:10px 0;font-size:1.1rem;">‚è±Ô∏è Execution Time</h3>';
      Object.entries(timings).forEach(([name, time]) => {
        const bar = document.createElement('div');
        bar.className = 'histo-bar';
        bar.style.width = `${Math.min(time * 2, 600)}px`;
        bar.innerHTML = `<span class="histo-label">${name}: ${time.toFixed(1)} ms</span>`;
        histogramEl.appendChild(bar);
      });
    }

    async function runSelectedAlgorithm() {
      resetBars();
      const algo = algoSelect.value;
      if (algo === 'bubble') await bubbleSort();
      else if (algo === 'selection') await selectionSort();
      else if (algo === 'insertion') await insertionSort();
      else if (algo === 'merge') await mergeSort();
      else if (algo === 'quick') await quickSort();
      else if (algo === 'counting') await countingSort();
    }

    function startAuto() {
      if (stepMode) return;
      stepMode = false;
      stepControl.style.display = 'none';
      stepQueue = [];
      runSelectedAlgorithm();
    }

    function startStepByStep() {
      stepMode = true;
      stepControl.style.display = 'block';
      const t = translations[currentLang];
      stepInfo.textContent = t.ready;
      stepQueue = [];
      runSelectedAlgorithm();
    }

    function nextStep() {
      const t = translations[currentLang];
      if (stepQueue.length > 0) {
        const next = stepQueue.shift();
        next();
        stepInfo.textContent = t.steps + stepQueue.length;
      } else {
        stepInfo.textContent = t.done;
      }
    }

    function cancelStepMode() {
      stepMode = false;
      stepControl.style.display = 'none';
      stepQueue = [];
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    setLanguage(currentLang);
    generateArray();

    const initInteractions = () => {
      initAudio();
      document.body.removeEventListener('touchstart', initInteractions);
      document.body.removeEventListener('mousedown', initInteractions);
    };
    document.body.addEventListener('touchstart', initInteractions, { once: true });
    document.body.addEventListener('mousedown', initInteractions, { once: true });
  </script>
</body>
</html>